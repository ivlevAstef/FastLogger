//
//  LogFormat.swift
//  FastLogger
//
//  Created by Alexander Ivlev on 05.10.2023.
//  Copyright Â© 2023 Alexander Ivlev. All rights reserved.
//

import Foundation

/// ÐžÐ¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð¸Ð· Ñ‡ÐµÐ³Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾ÑÑ‚Ð¾ÑÑ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð»Ð¾Ð³Ð°.
public enum LogFormatItem {
    /// Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ð´Ð°Ñ‚Ñ‹+Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸.
    public enum DateFormat {
        /// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ñ‚Ð°ÐºÐ¾Ð¹ Ð¼Ð°ÑÐºÐµ: `mm:ss.SSS`. 
        /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%Dd`.
        case debug
        /// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ñ‚Ð°ÐºÐ¾Ð¹ Ð¼Ð°ÑÐºÐµ: `HH:mm:ss.SSS`. 
        /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%Dn`.
        case nano
        ///  `yyyy-MM-dd HH:mm:ss.SSS`. 
        ///  Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%Da`.
        case any
        /// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ñ‚Ð°ÐºÐ¾Ð¹ Ð¼Ð°ÑÐºÐµ: `MM-dd HH:mm:ss`.  
        /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%Df`.
        case file
        /// ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‚ÑŒ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‚ÐµÑ€ Ð´Ð°Ñ‚Ñ‹. Ð”Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ Ð½Ð°Ð´Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²ÐµÑ€Ð½ÑƒÑŽ ÑÑ‚Ñ€Ð¾Ñ‡ÐºÑƒ Ð´Ð»Ñ `dateFormat` Ñƒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‚ÐµÑ€Ð°.
        /// Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð½ÐµÑ‚.
        case custom(DateFormatter)
    }

    /// Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑƒÑ€Ð¾Ð²Ð½Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.
    public enum LevelFormat {
        /// ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÑƒÑ€Ð¾Ð²Ð½Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð·Ð°Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¼Ð¸ Ð±ÑƒÐºÐ²Ð°Ð¼Ð¸. "FATAL", "ASSERT", "ERROR", "WARNING", "INFO", "DEBUG", "TRACE".
        /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%L`
        case long
        /// ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÑƒÑ€Ð¾Ð²Ð½Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ. "FTL", "AST", "ERR", "WRG", "INF", "DBG", "TRC".
        /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%s`
        case short
        /// Ð­Ð¼Ð¾Ð´Ð·Ð¸ Ð´Ð»Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ñ ÑƒÑ€Ð¾Ð²Ð½Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ. "ðŸ›‘", "â‰ï¸", "â—ï¸", "âš ï¸", "ðŸ”¹", "â–¶ï¸", "ðŸ—¯".
        /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%e`
        case emoji
    }

    /// Ð’Ñ‹Ð²Ð¾Ð´ Ð´Ð°Ñ‚Ñ‹+Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ ÐºÐ¾Ð³Ð´Ð° Ð±Ñ‹Ð»Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ.
    case date(DateFormat)
    /// Ð’Ñ‹Ð²Ð¾Ð´ ÑƒÑ€Ð¾Ð²Ð½Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.
    case level(LevelFormat)
    /// Ð’Ñ‹Ð²Ð¾Ð´ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð¿Ð°ÐºÐµÑ‚Ð°, Ð² ÑÐ»ÑƒÑ‡Ð°Ðµ ÐµÑÐ»Ð¸ Ð¾Ð½ ÑƒÐºÐ°Ð·Ð°Ð½.
    /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%p`
    case package
    /// Ð’Ñ‹Ð²Ð¾Ð´ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð°, Ð¸Ð· ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð²Ñ‹Ð·Ð¾Ð² Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.
    /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%f`
    case file
    /// Ð’Ñ‹Ð²Ð¾Ð´ ÑÑ‚Ñ€Ð¾Ñ‡ÐºÐ¸ ÐºÐ¾Ð´Ð°, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð²Ñ‹Ð·Ð¾Ð² Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.
    /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%l`
    case line
    /// ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ð° Ð¸Ð· ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð²Ñ‹Ð·Ð¾Ð² Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.
    /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%M`
    case method

    /// Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð±Ñ‹Ð»Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð¾ Ð² Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.
    /// Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `%m`
    case message

    /// ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ°. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð² Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð².
    /// Ð’ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð¼ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÑ‚Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð½Ðµ Ð¿Ð¾Ð¿Ð°Ð»Ð¸ Ð¿Ð¾Ð´ Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸.
    case string(String)
}

public typealias LogFormat = [LogFormatItem]

extension LogFormat {
    /// Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð¿Ð¾ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð¼Ñƒ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸ÑŽ.
    public static func format(by string: String) -> LogFormat {
        let characters = string.map { "\($0)" }

        var result: [LogFormatItem] = []
        var cacheStr: String = ""
        var index = 0
        while index < characters.count {
            func getFormat() -> (item: LogFormatItem, size: Int)? {
                if characters[index] == "%" && index + 1 < characters.count {
                    switch characters[index+1] {
                    case "D":
                        if index + 2 < characters.count {
                            switch characters[index+2] {
                            case "d": return (.date(.debug), 2)
                            case "n": return (.date(.nano), 2)
                            case "a": return (.date(.any), 2)
                            case "f": return (.date(.file), 2)
                            default: return nil
                            }
                        }
                        return nil
                    case "L": return (.level(.long), 1)
                    case "s": return (.level(.short), 1)
                    case "e": return (.level(.emoji), 1)
                    case "p": return (.package, 1)
                    case "f": return (.file, 1)
                    case "l": return (.line, 1)
                    case "M": return (.method, 1)
                    case "m": return (.message, 1)
                    default: return nil
                    }
                }
                return nil
            }

            if let (item, offset) = getFormat() {
                if !cacheStr.isEmpty {
                    result.append(.string(cacheStr))
                    cacheStr = ""
                }
                result.append(item)
                index += 1 + offset
            } else {
                cacheStr += characters[index]
                index += 1
            }
        }

        if !cacheStr.isEmpty {
            result.append(.string(cacheStr))
        }

        return result
    }
}
